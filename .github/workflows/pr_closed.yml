name: pr_closed

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  print_values:
    runs-on: ubuntu-latest
    steps:
      - name: print values
        run: |
          echo 'github: ${{ toJSON(github) }}'
          echo ''
          echo -n 'node:    ' ; which node
          echo -n 'python:  ' ; which python
          echo -n 'python2: ' ; which python2
          echo -n 'python3: ' ; which python3
          echo -n 'go:      ' ; which go
          echo -n 'gcc:     ' ; which gcc
          echo -n 'perl:    ' ; which perl
          echo -n 'jq:      ' ; which jq
  notify_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: prepare and send message
        run: |
          echo -n '' > msg.json
          echo -n '{"channel":"#test","text":"The following PR has been merged:\n' >> msg.json
          echo -n '${{github.event.pull_request.title}} [#${{github.event.pull_request.number}}](${{github.event.pull_request.html_url }})\n' >> msg.json
          echo -n 'Opened by ${{github.event.pull_request.user.login }}\n ' >> msg.json
          echo -n 'Commits: \n' >> msg.json
          curl ${{ github.event.pull_request.commits_url }} | jq -r '.[] | " * " + .sha[:8] + " " + .commit.message' | perl -npe 's/\n/\\n/g' >> msg.json
          echo -n '"}' >> msg.json
          echo '' >> msg.json
          echo ":::::::::::::::"
          cat msg.json
          echo ":::::::::::::::"
          curl -v ${{ secrets.ROCKET_CHAT_SERVER_URI }}/api/v1/chat.postMessage \
            -X POST \
            --data @msg.json \
            -H "X-Auth-Token: ${{ secrets.ROCKET_CHAT_TOKEN }}" \
            -H "X-User-Id: ${{ secrets.ROCKET_CHAT_USER_ID }}" \
            -H "Content-Type: application/json"
          echo ":::::::::::::::"
          echo -n '' > msg-slack.json
          echo -n '{"text":"The following PR has been merged:\n' >> msg-slack.json
          echo -n '${{github.event.pull_request.title}} [#${{github.event.pull_request.number}}](${{github.event.pull_request.html_url }})\n' >> msg-slack.json
          echo -n 'Opened by ${{github.event.pull_request.user.login }}\n ' >> msg-slack.json
          echo -n 'Commits: \n' >> msg-slack.json
          curl ${{ github.event.pull_request.commits_url }} | jq -r '.[] | " * " + .sha[:8] + " " + .commit.message' | perl -npe 's/\n/\\n/g' >> msg-slack.json
          echo -n '"}' >> msg-slack.json
          echo '' >> msg-slack.json
      - name: Post to a Slack channel
        id: slack
        uses: slackapi/slack-github-action@v1.18.0
        with:
          # For posting a rich message using Block Kit
          payload-file-path: "msg-slack.json"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
